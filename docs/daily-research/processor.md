## 实时操作系统基于多核处理器的调度算法
    
1.  RTOS的分类RTOS可划分为3个不同的领域：
    1.  系统级：指RTOS运行在1个小型的计算机系统中完成实时的控制作用。这个领域将主要是微软与Sun竞争之地，传统上Unix在这里占有绝对优势。Sun通过收购，让他的Solaris与 Chrous os（原欧洲的1种RTOS）结合，微软力推NT的嵌入式版本"Embedded NT"。此外，嵌入式Linux将依托源程序码开放和软件资源丰富的优势，进入系统级RTOS的市场。
    2.  板级：传统的RTOS的主要市场。如Vxwork, PSOS, QNX, Lynx和VRTX的应用将主要集中在航空航天、电话电讯等设备上。
    3.  SOC级（即片上系统）：新一代RTOS的领域：主要应用在消费电子、互联网络和手持设备等产品上。代表的产品有Symbian 的Epoc、ATI 的Nucleus, Express logic 的Threadx。老牌的RTOS厂家的产品VRTX和Vxwork 也很注意这个市场。
    从某种程度讲，不会出现1个标准的RTOS（像微软的Windows在桌面系统中的地位一样），因为嵌入式应用本身就极具多样性。在某个时间段以及某种行业，会出现1种绝对领导地位的RTOS，比如今天在宽带的数据通信设备中的Vxwork和在亚洲手持设备市场上的WinCE就是一例子。但是，这种垄断地位也并不是牢不可破的，因为在某种程度上用户和合作伙伴更愿意去培养1个新的竞争对手。比如，Intel投资的Montivista和Motorola投资的Lineo，这两家嵌入式Linux系统，就是说明半导体厂商更愿意看到1个经济适用的、开放的RTOS环境。

## QNX
    在调研实时操作系统的基于多核处理器的调度算法时，发现了一个评价很高的嵌入式实时操作系统QNX（可以基于多核处理器），但不是开源的。
    在高级安全机制第一条提到了系统特权细分精细分级控制，这里与sel4相似？QNX是业界公认的X86平台上最好的嵌入式实时操作系统之一。
    
1.  列出QNX的一部分优势
    1. 高可靠性、低风险
        QNX® Neutrino® RTOS 应用于要求严格且零故障的系统，建立在数十年实际经验的基础上。

        自 1980 年起，制造商们纷纷依靠 QNX 的 RTOS 技术来支撑他们的任务关键型应用——从医疗设备和网络路由器到车载信息设备、911 呼叫中心、进程控制程序以及空中交通管制系统。

        无论大小、是简单的单机系统还是复杂的分布式系统，均以其全天候不间断的运行方式赢得了绝佳的声誉。经过时间考验和现场验证的 QNX Neutrino RTOS 确立了行业的可靠性、容错性和可扩展性标准。
    2.  高级安全机制
        细分精细分级的权限控制、256 位 AES 加密文件系统、ASLR、堆栈保护和 MAC 为您的系统保障了无与伦比的安全性。

        QNX 设立了高级分层安全机制，直接建置在操作系统和内核中。借助以下特性，QNX 为您创建的系统能够发挥最佳安全效用：

        1. 系统特权细分精细分级控制。
        2. 现代化分层构建方法。
        3. 沙箱。
        4. 安全启动。
        5. 加密和只读文件系统。
        6. 堆栈和内存保护，包括 ASLR。
        7. 异常检测。
        这些特性减小了系统的安全攻击面，相应地减少了攻击唤醒。

    3.  能耗更低
        QNX 的自定义动力策略包括无间断运行、延迟计时和可选的热态和功率分布。

        QNX 通过操作系统和内核直接提供先进的热态和功率管理功能，以以下方式降低了移动和用电设备的能耗：

        无间断模式—系统处于空闲状态时跳过不必要的时钟周期
        容错计时器—计时器对非实时计时要求（如 UI 响应计时器）可以容错
        延时中断—非实时设备可延时中断（如键盘中断事件）
        动态电压和频率调节—针对 ARM Cortex SoC 的 DVFS

    4.  自愈系统
        QNX 故障隔离微内核架构与路径名基础上的名称解析相结合，赋予系统传说级的显示运行时间和可用性。

        QNX Neutrino RTOS 具有其他商用型 RTOS 无法提供的容错和故障恢复功能。其微内核架构使所有驱动程序、协议栈、文件系统和应用程序都在内核以外的内存受保护的用户空间内安全运行。几乎所有组件都能在出现故障时自动重启，而不会影响其他组件或内核。

    5.  可扩展及标准合规
        无论是大型还是小型系统，无论是单核还是多核处理系统，都可以采用相同的 RTOS、工具、API 和源代码来开发和执行标准合规系统，以满足不同的要求。

        QNX Neutrino 历经全新开发过程，达到 POSIX 1003.1 标准要求并通过 IEEE 1003.13-2003 指定的 POSIX PSE52 配置文件认证。

    6.  有保障的系统资源
        实时调度保障了线程按需运行，而 QNX 自适应分区技术确保了可用 CPU 始终充足。

        在正常运行条件下，QNX 自适应分区技术允许应用程序使用所有可用的 CPU 周期，而在过载运行条件下，它会硬性保障资源可用，确保应用程序根据各自预算获得必要的资源。

2.  官网：http://www.qnx.com/content/qnx/cn/products/neutrino-rtos/neutrino-rtos.html#%E6%8A%80%E6%9C%AF
    参考：https://blog.csdn.net/haima1998/article/details/17789085
    通过QNX的例子发现，已经有支持多核处理器的实时嵌入式操作系统


##  常见的调度算法
1. 先来先服务调度算法FCFS
2. 短作业（进程）优先调度算法SJF（非抢占）/SPF（抢占）
3. 高优先权优先调度算法HPF
4. 基于时间片的轮转调度算法RR
    1. 时间片轮转算法
    2. 多级反馈队列算法FB

## 


1.  ref
    1.  基于多核的嵌入式操作系统的研究和设计 https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CMFD&dbname=CMFD2012&filename=1011292401.nh&v=QzVMjO8gx9HNLh3IotQypnFPpd9WDV5fxMZBcaZ3bpzlWfQZBJJTvqLrpbCEPZ4H
    2.  基于Linux的多核实时任务调度算法改进 https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFDLAST2020&filename=JZCK202011048&v=ZCuElG4YasaNq%25mmd2F7dxIl090D4O1%25mmd2FeYQ87PpnPNeZtxHBRrpLlKmX77%25mmd2FPxOE8pit%25mmd2F9
    3.  支持多核处理器的星载嵌入式操作系统的研究与实现 https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CMFD&dbname=CMFD2010&filename=2009214427.nh&v=bh23sfuQN6HdcJgR8ksO2mvhJ4926EhSMoeGbuJiSs4cA1EhvbtxsiTuly3wSYXE
    4.  基于多核处理器的实时操作系统的扩展 https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CMFD&dbname=CMFD0506&filename=2006111932.nh&v=zqb8C0iO%25mmd2BetTvSv%25mmd2FlN4tKTttL8BInAb%25mmd2B9HL36Mmw6rW8OADYl%25mmd2F5qmueKPEzIIrqj
    5.  一种基于分组的多核嵌入式实时调度算法 https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFDLAST2016&filename=WXYJ201610007&v=KXH%25mmd2Bm8JGc38DceLduf1NLV14ylK17NIWK8hXikBviu2lf%25mmd2Bruuh5XlWv7zxJD9yIZ
    6.  多核平台下强实时操作系统QNX调度机制的应用研究 https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CMFD&dbname=CMFD201302&filename=1013249329.nh&v=quETlUPC1v16GIcJM1Kf9iivPGS8RyKO3m06BM9HiY6Xh2GZVBBZBJ4CTlptXS0i
    7.  https://kns.cnki.net/kns8/defaultresult/index 相关文章
    8.  https://kns.cnki.net/kns8/defaultresult/index 相关文章
    9.  https://kns.cnki.net/kns8/defaultresult/index 相关文章

##  下一步的调研
    单核到多核的需要增加的地方

    RTOS的发展与微电子和集成电路的发展息息相关,现在市场已经有具有八个核心的嵌入式处理,但是同构多核的性能不能完全适应嵌入式的应用,在嵌入式领域中更加具有应用前景的是异构多核。来自多核嵌入式实时操作系统（RTOS）综述.张朝.中国工程物理研究院计算机应用研究所
##
1.  背景：
    早期的嵌入式应用由于嵌入式处理器运算能力低,所以功能单一,主要使用死循环代码实现。随着大规模集成电路技术的发展和摩尔定律(Moore Law)的驱使,嵌入式处理器的性能越来越强,如今已经可匹敌桌面电脑。现在的嵌入式应用已经十分复杂,往往一个嵌入式应用需要集成数个功能,这种多任务环境的嵌入式应用已经离不开嵌入式操作系统的支持。针对特定的实时性要求严格的应用场景,比如工业控制、军事武器,更需要嵌入式实时操作系统的支持。当通提升过主频来提升处理器性能达到瓶颈时,多核技术的出现解决了单核芯片的性能瓶颈,使得处理性能的提升有了新的发展方向,尤其是异构多核技术同时保障了性能和功耗。然而多核技术却为嵌入式实时操作系统的设计者带来了不少的挑战。

    单处理器速度的不断提升，导致了其性能上出现了瓶颈，代价与处理器速度的比值越来越大，急需从技术上进行新的设计，因此采用并行处理将任务进行分解是一种比较理想的解决办法。多核的技术思想是：将两个或者多个独立的核封装到一个芯片内部，由多个核并行地计算。通过这样做，不仅获得较高处理器性能，还可以将处理器主频保持在较低的水平。虽然目前主流的操作系统已经对PC上的多核处理器提供了完善的支持，但在嵌入式领域，多核处理器的应用很少。传统的实时操作系统还没有完全提供对多核处理器的支持，如本文所研究的uC/OS-Ⅱ是不支持多核处理器的实时操作系统。
 
    因为所研究的uC/OS-Ⅱ是一个主要提供任务管理等基本功能的微内核，所以本文主要从任务管理的角度来研究基于多核的实现方案。

    μC/OS-II 是由美国 Labrosse 先生开发的小型嵌入式操作系统，提供了嵌入式系统的基本功能，其核心代码量较小。μC/OS-II 是基于优先级的抢占式实时多任务操作系统，包含了实时内核、任务管理、时间管理、任务间通信同步和内存管理等功能。绝大部分代码用 C 语言写成，与硬件相关部分用汇编语言编写，且它的源代码是公开免费的。μC/OS-II 是面向中小型嵌入式系统的。包含全部功能模块的内核大约为 10KB，如果经过裁减只保留核心代码，则可压缩到3KB 左右。μC/OS-II 的特点主要包括：源码公开、可移植性强、可裁剪、稳定性与可靠性都很强。它已经被移植到许多不同种类的 CPU 上，如 ARM 系列、Intel 公司的 80x86 系列、摩托罗拉公司的 Power PC 系列。


2.  对多核支持的三种典型方案
    
    1. WindRiver 公司的 VxWorks 采用基于同步原语的扩展方式。VxWorks 在处理器的每个核上都运行一个相同的实时操作系统，建立扩展的组件库，通过组件库中的同步原语实现各个核之间的通信。这种技术优点是扩展到多核不用做太多的修改，通过增加一个组件库就可以支持多核，缺点是增加了存储空间的需求。
    2. QNX 是一种分布式的 RTOS。它采用了微内核和分布式技术支持多核。QNX 各个模块相对独立，操作系统只提供基本的服务如任务调度和同步等。其它的服务都可以作为单独的任务和内核通信。（也有说QNX支持AMP和SMP的混合模式：BMP模式。）
    3. Linux 改进后的实时操作系统。由 Linux 发展来的嵌入式 Linux 采取用一个内核来统一分配任务调度和管理各个内核的资源。
 
    这三种方案进一步可划分为两种支持多核的操作系统模式：以 VxWorks 和 QNX 为代表的AMP(Asymmetric Multi-Processing)模式和以嵌入式 Linux 为代表的 SMP模式。
    uC/OS-Ⅱ采用的是与Linux类似的SMP模式。

3.  保留的部分以及改进的部分 P28
    1. 保留的部分：
    M_μCOS 在设计过程中保留了原来操作系统的大部分功能，这些功能主要包括：
    （1）基本保留原有的数据结构。这些数据结构包括任务控制块 OS_TCB、事件控制块ECB等、内存控制块 OS_MEM 等，保留原有的任务就绪表结构、任务查找算法、事件处理方法和内存管理方法等，在需要时再添加多核环境下要求扩展的数据结构。
    （2）支持任务优先级的抢占式调度。任务管理的基本功能保留，包括任务的创建删除、任务状态的转变、获取任务的信息。
    （3）支持定时器的时钟管理和任务延时处理。定时器的时钟节拍由应用程序根据需要制定，一般可以到达毫秒级。系统可以指定当前任务延时 N 个时钟节拍，从而去执行下一个优先级最高的任务。
    （4）保留原有的事件处理功能，主要包括信号量处理、消息邮箱和消息队列，但是在事件处理的实现方式上有所区别。
    （5）保留了原有的内存管理功能，方便用户对内存的操作。

    2. 改进的部分： 
        1. 多个处理器核的启动顺序问题 P38
        2. 多核的同步和互斥问题（自旋锁）P39
        3. 多核的任务调度算法设计（在第4节中）
        4. 内核的移植工作（需要改变内核中与处理器有关的部分）
        扩展方式是基于Linux的模式

    3. μC/OS-II 的文件结构
    μC/OS-II 的文件结构包括 μC/OS-II 配置文件、与处理器类型无关的代码、与处理器类型有关的代码以及应用程序。其中应用程序和μC/OS-II配置文件需要由用户在使用应用程序时提供。与处理器类型无关的代码主要包括 μC/OS-II 的启动、任务管理、时间管理、信号量管理和内存管理等，这些模块都是作为嵌入式操作系统的内核函数的形式给出供用户使用。与处理器类型有关的代码在将其移植到不同类型的处理器时要做相应更改。P17

    对μC/OS-II的调整：优先级总量扩充，并且引进同优先级算法调度。（首先需要对任务控制块TCB的数据结构进行修改，任务创建过程的改进，TCB 的初始化过程，任务调度过程的实现）P25
 
    多核的任务调度算法设计。
    由于在多核应用下任务的数量可能会明显增多，原有的μC/OS-II 只有 64 个优先级且不支持同优先级任务的设计显得具有局限性。M_μCOS 设计了基于动态分配策略的调度算法，并且支持同优先级调度。
 
    变化不大的模块：时间管理、事件管理、内存管理等模块的设计。P35

    进行了 UML 建模工作，接着研究了设计过程中需要重点解决的几个问题，并提出了可行的算法设计。P38，P39，P44
    

4.  多核调度算法选择 P44
    1. 多处理器系统的任务调度算法非常关键。然而多处理器调度的难点是如何确定任务分配给哪个处理器及任务分配给处理器后何时开始执行，这是一个 NP 完全问题（多项式复杂程度的非确定性问题）。如果任务为周期性任务，则相对比较好解决。如果任务为一般任务，则相对复杂。多处理器调度算法的设计要点主要有以下三点：
    (1)  第一是如何把处理器分配给任务，有两种方式可供选择：静态分配策略，即一个任务永久分配给同一个处理器；动态分配策略，所有处理器公用一个就绪列表，当某个处理器空闲时，选择一个就绪任务运行。
    (2)  第二是是否支持多道程序设计，即在计算机内存中同时存放几道相互独立的程序，使它们在管理程序控制之下相互穿插的运行。对于小型的嵌入式系统的应用相对比较简单，一般不需要采用多道程序设计。
    (3)  第三是实际指派任务的方式。
    比较常用的有时间片轮转调度法和单处理器扩展后的调度算法。
    
    单处理器扩展后的调度法：在单处理器中比较常见的 FCFS（先来先服务）算法、SJF（短作业优先）算法和 EDF（最早截止期优先）算法等[37]  -[39]。如果将其运用于小型的嵌入式多核操作系统是比较好的，其算法简单，修改起来比较方便，因此得到广泛应用。实验证明处理器的数目增多会导致复杂调度算法的有效性逐渐降低，因此大多数采用动态分配策略的多核系统的调度算法往往采用简单的单处理扩展后的调度法，就绪任务组成一个或者多个按优先级大小排列的队列。本文所采用的调度算法就是基于单处理器扩展后的调度算法。

    2. 在设计多核调度算法时，需要能够正确地将各个就绪任务分配到适当的内核上运行。在分配任务时需要考虑的几个主要问题为：
    (1)  任务就绪模型的选择。
    比较流行的任务就绪模型有：全局就绪队列和局部就绪队列。Linux 使用是局部就绪队列，每个核有自己的任务就绪队列。而全局就绪队列是将所有的任务放到一个就绪队列中来，每个任务都可以在任何一个内核中运行。通过分析原内核的任务调度模型，可以看出全局就绪队列更适用于 M_μCOS 的任务就绪模型，M_μCOS 通过调度器可以更容易地控制各个任务的调度，更利于实现负载均衡。
    (2)  算法的时间复杂度。
    实时系统的调度延时是其性能的重要指标，由于 μC/OS-II 采取的任务就绪表使得最高优先级任务选择是 O(1)级的，所以在 M_μCOS 中基于多核的任务分配算法沿用了这种结构的任务就绪表寻找最高优先级的一组任务，保证了调度算法的时间复杂性以及系统的实时性。
    (3)  任务切换次数。
    任务切换也叫上下文切换。当发生中断时，抢占式的实时系统会发生任务切换，寻找当前优先级最高的任务调度。在多核系统中，设计的调度算法必须保证全局任务切换次数最少，否则频繁发生任务切换必然会影响操作系统的性能。如图 4.10 所示，双核处理器各个内核当前运行的任务的优先级由大到小依次为 Task1 和Task2，这时有优先级最高的 Task0 进入就绪队列，这时会产生任务切换。左侧发生了 2 次任务切换，是应当避免发生的任务切换算法，会降低 CPU的性能。而如果采取了右侧的全局任务切换算法，只需要一次任务切换就可以保证任务的正确调度，极大的提高了算法的性能指标。

    M_μCOS采用的调度算法将尽量减少任务切换次数。M_μCOS的任务切换发生在两个地方：一个是时钟中断发生时，系统需要检测每个核上运行的任务是否是优先级最高的任务，如果不是则发生任务切换；一个是任务主动延时产生的任务切换，这个处理过程需要调用任务调度器 OSSched( )函数来处理。在设计调度算法前，还需要先修改任务控制块。

5. 支持多核的嵌入式操作系统的测试方法（测试方面参考文献4）
    1. 功能测试:
        1. 多核管理功能
        2. 多核同步功能
        3. 多核调度问题
    2. 性能测试（参考）
        1. 任务切换时间
        2. 任务抢占时间
        3. 中断响应问题
        4. 运算性能
        5. 信号量延迟时间
        6. 核间同步时间
        7. 内存读写时间
        8. 文件读写速率
        9. 图形性能测试
    3. 安全测试

6. 操作系统的测试平台
    1. Qemu是一个开源的托管虚拟机，通过纯软件来实现虚拟化模拟器，几乎可以模拟任何硬件设备。比如：Qemu可以模拟出一个ARM系统中的：CPU、内存、IO设备等，然后在这个模拟层之上，可以跑一台ARM虚拟机，这个ARM虚拟机认为自己在和硬件进行打交道，但实际上这些硬件都是Qemu模拟出来的。
    2. ![](assets/1.png)
    3. freertos windows模拟器 [amazon freertos windows 模拟器](https://docs.aws.amazon.com/freertos/latest/userguide/getting_started_windows.html)  
    ![](assets/2.png)

参考文献：
   1. [基于多核的嵌入式操作系统的研究和设计.王凯.南京航空航天大学]
   2. [多核平台下强实时操作系统QNX调度机制的应用研究.任宁宁.西南交通大学]
   3. [多核嵌入式实时操作系统（RTOS）综述.张朝.中国工程物理研究院计算机应用研究所]
   4. [多核嵌入式实时操作系统测试方法.沈旻园 傅俊彦.中国电子科技集团公司第三十二研究所](https://kns.cnki.net/KXReader/Detail?TIMESTAMP=637534191326044922&DBCODE=CJFD&TABLEName=CJFDLAST2017&FileName=SZJT201702116&RESULT=1&SIGN=r8FNi8N2L4alm7VSj8HANbdQHB4%3d)
   5. [Nios® II 处理器设计工具](https://www.intel.cn/content/www/cn/zh/products/programmable/processor/nios-ii/design-tools.html)
   6. [基于虚拟机QEMU的嵌入式全系统仿真测试环境的研究与实现](https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFD2011&filename=HKDZ201104010&v=Cv3zf7CjwQym%25mmd2BE%25mmd2BHUNCxmbnA4pI%25mmd2BQ%25mmd2FGLrJExt8sNxdBm%25mmd2F6cusihZDjbdW5y%25mmd2BmBxK)
   7. [基于MACPI的嵌入式多核通信机制的研究](https://kns.cnki.net/kcms/detail/detail.aspx?dbcode=CJFD&dbname=CJFDLAST2017&filename=WXYJ201711017&v=Ee7fsMB0f2FjK%25mmd2FWmyLyy897dN0zH3YFrv%25mmd2FbbDyZaG7qJy469QXihvkVjP%25mmd2BqMwXz%25mmd2B)
   8. [A Multi-Core Version of FreeRTOS Verified for Datarace and Deadlock Freedom](https://dl.acm.org/action/doSearch?AllField=freertos)
   9. [将 FreeRTOS 调整为多核：体验报告](https://onlinelibrary.wiley.com/doi/full/10.1002/spe.2188)
